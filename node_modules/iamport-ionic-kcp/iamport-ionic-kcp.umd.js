(function (global, factory) {
	typeof exports === 'object' && typeof module !== 'undefined' ? factory(exports, require('@angular/core'), require('ionic-angular/index'), require('@ionic-native/in-app-browser/index')) :
	typeof define === 'function' && define.amd ? define(['exports', '@angular/core', 'ionic-angular/index', '@ionic-native/in-app-browser/index'], factory) :
	(factory((global['iamport-ionic-kcp'] = {}),global.core,global.index,global.index$1));
}(this, (function (exports,core,index,index$1) { 'use strict';

var IamportService = (function () {
    /**
     * @param {?} platform
     * @param {?} inAppBrowser
     */
    function IamportService(platform, inAppBrowser) {
        this.platform = platform;
        this.inAppBrowser = inAppBrowser;
    }
    /**
     * @param {?} query
     * @return {?}
     */
    IamportService.parseQuery = function (query) {
        var /** @type {?} */ obj = {}, /** @type {?} */ arr = query.split('&');
        for (var _i = 0, arr_1 = arr; _i < arr_1.length; _i++) {
            var element = arr_1[_i];
            var /** @type {?} */ pair = element.split("=");
            obj[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
        }
        return obj;
    };
    /**
     * @param {?} userCode
     * @param {?} param
     * @return {?}
     */
    IamportService.prototype.payment = function (userCode, param) {
        var _this = this;
        var /** @type {?} */ promise = new Promise(function (resolve, reject) {
            _this.platform.ready().then(function () {
                var /** @type {?} */ paymentUrl = 'iamport-checkout.html?user-code=' + userCode;
                var /** @type {?} */ redirectUrl = "http://localhost/iamport";
                var /** @type {?} */ browser = _this.inAppBrowser.create(paymentUrl, '_blank', 'location=no');
                var /** @type {?} */ paymentProgress = false;
                param.m_redirect_url = redirectUrl;
                browser.on("loadstart")
                    .subscribe(function (e) {
                    if (e.url.startsWith(redirectUrl)) {
                        var /** @type {?} */ query = e.url.substring(redirectUrl.length + 1);
                        var /** @type {?} */ data = IamportService.parseQuery(query);
                        resolve(data);
                        browser.close();
                    }
                });
                browser.on("loadstop")
                    .subscribe(function (e) {
                    if (!paymentProgress && (e.url).indexOf(paymentUrl) > -1) {
                        paymentProgress = true;
                        var /** @type {?} */ inlineCallback = "(rsp) => {\n                                                        if( rsp.success ) {\n                                                            location.href = '" + redirectUrl + "?imp_success=true&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid;\n                                                        } else {\n                                                            location.href = '" + redirectUrl + "?imp_success=false&imp_uid='+rsp.imp_uid+'&merchant_uid='+rsp.merchant_uid+'&error_msg='+rsp.error_msg;\n                                                        }\n                                                   }";
                        var /** @type {?} */ iamport_script = "IMP.request_pay(" + JSON.stringify(param) + ", " + inlineCallback + ")";
                        browser.executeScript({
                            code: iamport_script
                        });
                    }
                });
                browser.on("exit")
                    .subscribe(function (e) {
                    reject("사용자가 결제를 취소하였습니다.");
                });
                browser.show();
            });
        });
        return promise;
    };
    return IamportService;
}());
IamportService.decorators = [
    { type: core.Injectable },
];
/**
 * @nocollapse
 */
IamportService.ctorParameters = function () { return [
    { type: index.Platform, },
    { type: index$1.InAppBrowser, },
]; };

exports.IamportService = IamportService;

Object.defineProperty(exports, '__esModule', { value: true });

})));
